<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Cell Segmentation - Shape Space Explorer</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Cell Segmentation | Shape Space Explorer</title> <meta name="generator" content="Jekyll v3.9.2" /> <meta property="og:title" content="Cell Segmentation" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." /> <meta property="og:description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." /> <link rel="canonical" href="http://localhost:4000/cell_segmentation/" /> <meta property="og:url" content="http://localhost:4000/cell_segmentation/" /> <meta property="og:site_name" content="Shape Space Explorer" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Cell Segmentation" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.","headline":"Cell Segmentation","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/sse_logo.png"}},"url":"http://localhost:4000/cell_segmentation/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="http://localhost:4000/about/" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="http://localhost:4000/getting_started/" class="nav-list-link">Getting Started</a></li><li class="nav-list-item active"><a href="http://localhost:4000/cell_segmentation/" class="nav-list-link active">Cell Segmentation</a></li><li class="nav-list-item"><a href="http://localhost:4000/shape_manifold_embedding/" class="nav-list-link">Shape Manifold Embedding</a></li><li class="nav-list-item"><a href="http://localhost:4000/display_shape_features/" class="nav-list-link">Display Shape Features</a></li><li class="nav-list-item"><a href="http://localhost:4000/inspect_shape_space/" class="nav-list-link">Inspect Shape Space</a></li><li class="nav-list-item"><a href="http://localhost:4000/extended_affinity_propagation/" class="nav-list-link">Extended Affinity Propagation</a></li><li class="nav-list-item"><a href="http://localhost:4000/group_analysis/" class="nav-list-link">Group Analysis</a></li><li class="nav-list-item"><a href="http://localhost:4000/out_of_sample_extension/" class="nav-list-link">Out of Sample Extension</a></li><li class="nav-list-item"><a href="http://localhost:4000/shape_space_dynamic/" class="nav-list-link">Shape Space Dynamic</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Shape Space Explorer" aria-label="Search Shape Space Explorer" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/rosegostner/shape" class="site-button" target="_blank" rel="noopener noreferrer" > Shape Space Explorer on GitHub </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 id="cell-segmentation"> <a href="#cell-segmentation" class="anchor-heading" aria-labelledby="cell-segmentation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Cell Segmentation </h1> <p>Cell Segmentation starts with the microscopy data in your Movie folder. ShapeSpaceExplorer uses <a href="https://www.openmicroscopy.org/bio-formats/downloads/">Bioformats</a> to read in the data. Check the <a href="https://docs.openmicroscopy.org/bio-formats/6.10.1/supported-formats.html">list of supported formats</a> to see if your data are supported.</p> <p>To run cell segmentation, run <code>ShapeSpaceExplorer &gt; 1-ImageSegmentationFull &gt; Run_CellSegmentation.m</code> which should show the interface below: <br /> <img align="center" width="500px" src="/cell_segmentation/img/select_data_folder.png" /></p> <p>Select your Movie folder containing your microscopy data, which should show all files in a selectable list. <br /> <img align="center" width="500px" src="/cell_segmentation/img/select_data_files.png" /></p> <p>Select all movies that should be analysed. Note that at least one file must be selected to continue. The loading of the next interface can be slow, because it calculates the number of frames of your shortest movie from all movies files.</p> <p>The interface offers two choices:</p> <ul> <li>Analyse all movies from start to end (default choice)</li> <li>Select a substack of your frames, which might be helpful if your data went out of focus. If you select a substack from frame A to frame B, this selection will automatically be applied to all movies in your analysis.</li> </ul> <p><img align="center" width="500px" src="/cell_segmentation/img/substack_choice.png" /></p> <p>The final interface asks you for the Analysis folder to save the output of the cell segmentation. Clicking on <code>Start Pre-processing</code> begins the automatic cell segmentation. This is a time intensive task and can take hours to days depending on your data size and available computing power. The segmentation parameters should optimised on a typical movie before running a large dataset. See <a href="#troubleshooting">Troubleshooting</a> for more information. <br /> <img align="center" width="500px" src="/cell_segmentation/img/select_analysis_folder.png" /></p> <p>Two progress bars indicate the movie and frame that are currently processed. At the end, the command line prints a note when the program finishes successfully. <br /> <img align="center" width="500px" src="/cell_segmentation/img/progress_bar1.png" /> <br /> <img align="center" width="500px" src="/cell_segmentation/img/progress_bar2.png" /> <br /> <img align="center" width="500px" src="/cell_segmentation/img/segmentation_finished.png" /></p> <p>After cell segmentation, the Analysis folder should have the following new files:</p> <ul> <li>ImageStackXXX.mat for each analysed movie</li> <li>ImageStackXXXCurveData.mat for each analysed movie</li> <li>FileMapping.csv: contains the mapping between the new movie names and the original movie names from the Movie folder. Excel can import CSV files.</li> </ul> <h2 id="troubleshooting"> <a href="#troubleshooting" class="anchor-heading" aria-labelledby="troubleshooting"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Troubleshooting </h2> <p>The cell segmentation in ShapeSpaceExplorer uses an EDISON (Edge Detection and Image SegmentatiON) implementation of the Mean Shift Algorithm within a MATLAB wrapper. Please see the <a href="/about/">About</a> page for links to original code and references.</p> <p>If the segmentation produces strange outputs, then there are two parameters to adjust the algorithm: Spatial Bandwidth and Range Bandwidth. These parameters are ideally optimised on a typical example image before attempting segmentation of a large dataset.</p> <p>Generally speaking, the range bandwidth influences how much noise the cell segmentation picks up. Should there be too many smalls blobs recognized as cells, this parameter should be increased.</p> <p>The spatial bandwidth, influences on how large the radius of a detected shape can be as smallest possible radius. Depending on your imaging conditions and average size of your cell, the interface permits to fine tune the cell segmentation step. Though, the proposed default values worked for a widee range of cases.</p> <p>An excellent detailed explanation on how the parameters influence cell segmentation can be found on <a href="http://en.wikipedia.org/wiki/Mean_shift">Wikipedia</a></p> <h2 id="manual-correction-of-cell-segmentation"> <a href="#manual-correction-of-cell-segmentation" class="anchor-heading" aria-labelledby="manual-correction-of-cell-segmentation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Manual Correction of Cell Segmentation </h2> <p>To inspect the cell segmentation results, run the file <code>1-ImageSegmentationFull &gt; Inspect\_Shapes.m </code> in the ShapeSpaceExplorer folder, which will open the Inspect_Shapes interface <br /> <img align="center" width="500px" src="/cell_segmentation/img/open_manual_inspect.png" /></p> <p>Click on the folder icon in the toolbar and select one of the files with the name format <code>ImageStackXXX.mat</code>, for example <code>ImageStack001.mat</code>. The program highlights the contours of the detected cells. The toolbar offers zoom in, zoom out and pan operations. The 8th icon from the left is the legend icons and permits you to see the id assigned to detected shapes. <img align="center" width="500px" src="/cell_segmentation/img/contour_highlights.png" /></p> <p>There are a variety of operations that permit to correct the automatic cell segmentation manually. Each of the operations is explained in the following sections.</p> <h3 id="delete-a-single-shape"> <a href="#delete-a-single-shape" class="anchor-heading" aria-labelledby="delete-a-single-shape"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Delete a Single Shape </h3> <p><img align="center" width="500px" src="/cell_segmentation/img/delete_single1.png" /></p> <p>Selecting the Cursor and clicking on a shape removes the shape from the detected cells, indicated by a grey outline. To remove a shape from a frame plus all future frame you need to hold down the key CTRL and click on the shape. To add the shape back to detected shapes, simply click with the Cursor selected inside the shape, which should re-colour the shape in a bright colour.</p> <h3 id="filter-out-shapes-with-small-area-size"> <a href="#filter-out-shapes-with-small-area-size" class="anchor-heading" aria-labelledby="filter-out-shapes-with-small-area-size"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Filter Out Shapes With Small Area Size </h3> <p><img align="center" width="500px" src="/cell_segmentation/img/filter_small.png" /></p> <h3 id="filter-out-shapes-with-small-life-span"> <a href="#filter-out-shapes-with-small-life-span" class="anchor-heading" aria-labelledby="filter-out-shapes-with-small-life-span"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Filter Out Shapes With Small Life Span </h3> <p><img align="center" width="500px" src="/cell_segmentation/img/filter_short.png" /></p> <h3 id="merge"> <a href="#merge" class="anchor-heading" aria-labelledby="merge"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Merge </h3> <p><img align="center" width="500px" src="/cell_segmentation/img/merge.png" /></p> <h3 id="manual-drawing"> <a href="#manual-drawing" class="anchor-heading" aria-labelledby="manual-drawing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Manual Drawing </h3> <p><img align="center" width="500px" src="/cell_segmentation/img/manual_drawing.png" /></p> <p>You have the full functionality of the <a href="https://uk.mathworks.com/help/images/ref/roipoly.html">MATLAB ROI tool</a>. Here is a basic guide:</p> <ul> <li>Delete: Backspace</li> <li>Adding a new vertex: Key A</li> <li>Delete vertex: right click, and select delete</li> <li>Closing Polygon: Move to an existing point and click on it.</li> </ul> <h3 id="continues-tracks"> <a href="#continues-tracks" class="anchor-heading" aria-labelledby="continues-tracks"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Continues Tracks </h3> <p>Continuous tracks are cell tracks that stretch from a start frame to an end frame, without any interruption. The cell with ID 1, appearing from frame 1 to 5, i.e. [1, 2, 3, 4, 5], would be an example. However, if the track would have a missing frame, say at frame 3, so that the sequence is [1, 2, 4, 5], then when the program saves your modification, it will assign a new ID to the second part, i.e. [4, 5], of the track.</p> <p>When you save 3 new files should be produced:</p> <ul> <li>CellArayXXX.mat</li> <li>CellFrameDataXXX.mat</li> <li>ManCorrtdCurvesXXX.mat</li> </ul> <h2 id="after-manual-correction"> <a href="#after-manual-correction" class="anchor-heading" aria-labelledby="after-manual-correction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> After Manual Correction </h2> <p>The program expects you to open each stack with the <code>InspectShape.m</code> program and save it from there. For each stack ImageStackXXX.mat, the program creates two files, namely CellArayXXX.mat, and CellFrameDataXXX.mat. The analysis integrates only stacks that have those two files generated. To proceed run <code>1-ImageSegmentationFull &gt; MakeBigStructs.m</code>. <img align="center" width="500px" src="/cell_segmentation/img/run_MakeBigStructs.png" /></p> <p>After selecting the Analysis folder, the program generates two files:</p> <ul> <li>Bigcellarrayandindex.mat</li> <li>BigCellDataStruct.mat</li> </ul><hr /> <p><strong>NOTE</strong></p> <p>You can construct the <code>Bigcellarrayandindex.m</code> and <code>BigCellDataStruct.mat</code> without manual correction; to do so, run <code>1-ImageSegmentationFull &gt; MakeBigStructsWithoutManual.m</code></p> <p>Running the program <code>MakeBigStructsWithoutManual.m</code> will not include any existing manual corrections!</p><hr /> <h2 id="manual-segmentation"> <a href="#manual-segmentation" class="anchor-heading" aria-labelledby="manual-segmentation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Manual Segmentation </h2> <p>Manually segmented shapes (for example by drawing outlines using the freehand tool in ImageJ and exporting the xy coordinates into individual textfiles) can be imported into ShapeSpaceExplorer. Please note that files should be tab-separated file with 3 columns. Following the header line these should contain only numbers: Point ID in the first column, x coordinates in the second column and y coordinates in the third column. These should be arranged in a folder structure like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
+-- Stack_001
|	+-- Cell_001
	|	+-- Results_1.txt
	|	+-- Results_2.txt
	|	+-- Results_3.txt
|	+-- Cell_002
	|	+-- Results_1.txt
	|	+-- Results_2.txt
	|	+-- Results_3.txt
|	+-- Cell_003
	|	+-- Results_1.txt
	|	+-- Results_2.txt
	|	+-- Results_3.txt
+-- Stack_002
|	+-- Cell_001
	|	+-- Results_1.txt
	|	+-- Results_2.txt
	|	+-- Results_3.txt
|	+-- Cell_002
	|	+-- Results_1.txt
	|	+-- Results_2.txt
	|	+-- Results_3.txt
|	+-- Cell_003
	|	+-- Results_1.txt
	|	+-- Results_2.txt
	|	+-- Results_3.txt
</code></pre></div></div> <p>Use the following Macro in ImageJ</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Macro allows manual extraction of cell shape and saves these as textfiles in the image folder.</span>

<span class="nx">macro</span> <span class="dl">"</span><span class="s2">Get cell shape [1]</span><span class="dl">"</span> <span class="p">{</span>

	<span class="nx">run</span><span class="p">(</span><span class="dl">"</span><span class="s2">Clear Results</span><span class="dl">"</span><span class="p">);</span>
		<span class="nx">getSelectionCoordinates</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
<span class="nx">setResult</span><span class="p">(</span><span class="dl">"</span><span class="s2">y</span><span class="dl">"</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">y</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="nx">setResult</span><span class="p">(</span><span class="dl">"</span><span class="s2">x</span><span class="dl">"</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">]);}</span>

<span class="nx">updateResults</span><span class="p">();</span>

<span class="nx">dir</span><span class="o">=</span><span class="nx">getDirectory</span><span class="p">(</span><span class="dl">"</span><span class="s2">image</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">roiManager</span><span class="p">(</span><span class="dl">"</span><span class="s2">Add</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">nROI</span> <span class="o">=</span> <span class="nx">roiManager</span><span class="p">(</span><span class="dl">"</span><span class="s2">count</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">selectWindow</span><span class="p">(</span><span class="dl">"</span><span class="s2">Results</span><span class="dl">"</span><span class="p">);</span>

   <span class="nx">name</span> <span class="o">=</span> <span class="nx">dir</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">Results_</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">nROI</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">.txt</span><span class="dl">"</span><span class="p">;</span>
   <span class="nx">saveAs</span><span class="p">(</span><span class="dl">"</span><span class="s2">Results</span><span class="dl">"</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>

<span class="nx">setForegroundColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nx">run</span><span class="p">(</span><span class="dl">"</span><span class="s2">Draw</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">slice</span><span class="dl">"</span><span class="p">);</span>

<span class="p">}</span>
</code></pre></div></div> <p>Now, run <code>1-ImageSegmentationFull &gt; ImportManual_Segs_plus_Struct.m</code>, which asks for the Experiment folder and then the Analysis folder as input. If successful, it will generate these two files:</p> <ul> <li>Bigcellarrayandindex.mat</li> <li>BigCellDataStruct.mat</li> </ul> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
